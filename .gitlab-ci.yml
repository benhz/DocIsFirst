# GitLab CI/CD Configuration for Docusaurus Project

stages:
  - install
  - test
  - build
  - deploy

# 用 Node.js 20 的镜像
image: node:20

# 缓存依赖
cache:
  paths:
    - node_modules/
    - .yarn/cache/

# 安装依赖
install:
  stage: install
  tags:
    - Upward-always
  script:
    - yarn install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 day
  only:
    - branches
    - tags
    - merge_requests

# 类型检查
typecheck:
  stage: test
  tags:
    - Upward-always
  dependencies:
    - install
  script:
    - yarn typecheck
  only:
    - branches
    - tags
    - merge_requests

# 构建 Docusaurus
build:
  stage: build
  tags:
    - Upward-always
  dependencies:
    - install
  script:
    - yarn build
  artifacts:
    paths:
      - build/
    expire_in: 7 days
  only:
    - branches
    - tags
    - merge_requests

# 部署到 GitLab Pages（只在 main/master）
pages:
  stage: deploy
  tags:
    - Upward-always
  dependencies:
    - build
  script:
    - mv build public
  artifacts:
    paths:
      - public
  only:
    - main
    - master

# MR 预览
preview:
  stage: deploy
  tags:
    - Upward-always
  dependencies:
    - build
  script:
    - echo "Preview available at https://$CI_PROJECT_NAME.pages.dev/$CI_COMMIT_REF_SLUG"
  artifacts:
    paths:
      - build/
    expire_in: 7 days
  only:
    - merge_requests
  except:
    - main
    - master
