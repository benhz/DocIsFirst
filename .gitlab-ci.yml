# GitLab CI/CD Configuration for Docusaurus Project

# Define stages
stages:
  - install
  - test
  - build
  - deploy

# Use Node.js Docker image (matching the required version)
image: node:20

# Cache node_modules to speed up builds
cache:
  paths:
    - node_modules/
    - .yarn/cache/

# Install dependencies
install:
  stage: install
  script:
    - yarn install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 day
  only:
    - branches
    - tags
    - merge_requests

# Type checking
typecheck:
  stage: test
  dependencies:
    - install
  script:
    - yarn typecheck
  only:
    - branches
    - tags
    - merge_requests

# Build the Docusaurus site
build:
  stage: build
  dependencies:
    - install
  script:
    - yarn build
  artifacts:
    paths:
      - build/
    expire_in: 7 days
  only:
    - branches
    - tags
    - merge_requests

# Deploy to GitLab Pages (only on main/master branch)
pages:
  stage: deploy
  dependencies:
    - build
  script:
    - mv build public
  artifacts:
    paths:
      - public
  only:
    - main
    - master

# Optional: Preview deployments for merge requests
preview:
  stage: deploy
  dependencies:
    - build
  script:
    - echo "Preview available at https://$CI_PROJECT_NAME.pages.dev/$CI_COMMIT_REF_SLUG"
  artifacts:
    paths:
      - build/
    expire_in: 7 days
  only:
    - merge_requests
  except:
    - main
    - master
